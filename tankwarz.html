<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>ü™ñ TankWarz</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{
  margin:0;background:#000;color:#fff;font-family:sans-serif;overflow:hidden;
  display:flex;justify-content:center;align-items:center;height:100vh;
}
#wrap{width:100%;height:100%;display:flex;justify-content:center;align-items:center;}
canvas{
  width:100%;max-width:400px;max-height:600px;aspect-ratio:2/3;
  background:#012;border-radius:8px;touch-action:none;display:block;
}
#overlay{
  position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;background:#000c;
  z-index:50;cursor:pointer;
}
#overlay h1{color:gold;font-size:8vw;margin:0;}
#overlay p{color:#ccc;font-size:4vw;}
#controls{
  position:fixed;left:50%;bottom:3vh;transform:translateX(-50%);
  display:flex;gap:4vw;
}
.btn{
  width:14vw;height:14vw;max-width:70px;max-height:70px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;background:#fff2;
  color:#fff;font-size:clamp(18px,5vw,28px);user-select:none;
}
#hud{position:fixed;top:10px;left:12px;display:flex;gap:20px;font-size:18px;}
#hudRight{
  position:fixed;top:10px;right:12px;display:flex;gap:12px;
  font-size:clamp(18px,3vw,28px);
}
#hudRight div{cursor:pointer;}
</style>
</head>
<body>
<div id="wrap"><canvas id="cv" width="400" height="600"></canvas></div>
<div id="overlay"><h1>ü™ñ TankWarz</h1><p>Press Enter / Tap to Start</p></div>
<div id="controls">
  <div class="btn" id="L">‚è™</div>
  <div class="btn" id="R">‚è©</div>
  <div class="btn" id="F">‚¨ÜÔ∏è</div>
  <div class="btn" id="S">üí£</div>
</div>
<div id="hud">
  <div id="scoreDisplay">Score: 0</div>
  <div id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
</div>
<div id="hudRight">
  <div id="musicToggle">üéµ</div>
  <div id="pauseToggle">‚è∏Ô∏è</div>
  <div id="restartBtn">üîÑ</div>
  <div id="exitBtn">‚ùå</div>
</div>

<script>
(()=>{
const cv=document.getElementById("cv"),ctx=cv.getContext("2d"),
O=document.getElementById("overlay"),
musicBtn=document.getElementById("musicToggle"),
pauseBtn=document.getElementById("pauseToggle"),
restartBtn=document.getElementById("restartBtn"),
exitBtn=document.getElementById("exitBtn"),
scoreDisplay=document.getElementById("scoreDisplay"),
livesDisplay=document.getElementById("livesDisplay");

// === AUDIO ===
const AC = new (window.AudioContext || window.webkitAudioContext)();
let themeMuted=false,themeInt=null;
function beep(type,freq=440,dur=0.1,vol=0.2){
 if(AC.state!=="running")return;
 const o=AC.createOscillator(),g=AC.createGain();
 o.type=type;o.frequency.value=freq;
 g.gain.setValueAtTime(vol,AC.currentTime);
 g.gain.exponentialRampToValueAtTime(0.001,AC.currentTime+dur);
 o.connect(g);g.connect(AC.destination);
 o.start();o.stop(AC.currentTime+dur+0.05);
}
function startTheme(){stopTheme();const seq=[330,440,554,659,554,440];let i=0;
 themeInt=setInterval(()=>{if(!themeMuted&&AC.state==="running")beep("square",seq[i++%seq.length],0.12,0.15);},300);}
function stopTheme(){if(themeInt){clearInterval(themeInt);themeInt=null;}}
function toggleTheme(){themeMuted=!themeMuted;musicBtn.textContent=themeMuted?"üîá":"üéµ";}

// === GAME STATE ===
let player,enemy,bullets,ebullets,explosions=[],walls=[];
let score=0,lives=3,level=1,paused=false,exited=false,gameOver=false,nextLevelPending=false;
const keys={},arena={w:400,h:600};

// === INPUTS ===
addEventListener("keydown",e=>{
 keys[e.code]=true;
 if(O.style.display!=="none"&&(e.code==="Enter"||e.code==="Space"))startGame();
});
addEventListener("keyup",e=>keys[e.code]=false);
function bindBtn(id,fn){const el=document.getElementById(id);el.addEventListener("pointerdown",ev=>{ev.preventDefault();fn();});}
bindBtn("L",()=>keys.ArrowLeft=true);
bindBtn("R",()=>keys.ArrowRight=true);
bindBtn("F",()=>keys.ArrowUp=true);
bindBtn("S",fire);
["L","R","F"].forEach(id=>{document.getElementById(id).addEventListener("pointerup",()=>{delete keys.ArrowLeft;delete keys.ArrowRight;delete keys.ArrowUp;});});
musicBtn.addEventListener("click",toggleTheme);
pauseBtn.addEventListener("click",()=>{paused=!paused;pauseBtn.textContent=paused?"‚ñ∂Ô∏è":"‚è∏Ô∏è";});
restartBtn.addEventListener("click",()=>{stopTheme();initGame(1);startTheme();});
exitBtn.addEventListener("click",()=>{exited=true;paused=true;stopTheme();O.style.display="flex";O.innerHTML="<h1>üëã Thanks for Playing!</h1><p>Press Enter / Tap to Restart</p>";});
O.addEventListener("click",startGame);

// === TAP + SWIPE GESTURES ===
let startX=0,startY=0,activeDir=null;
cv.addEventListener("touchstart",e=>{
 const t=e.touches[0];startX=t.clientX;startY=t.clientY;activeDir=null;
});
cv.addEventListener("touchmove",e=>{
 if(e.touches.length===0)return;
 const t=e.touches[0];
 const dx=t.clientX-startX,dy=t.clientY-startY;
 const absX=Math.abs(dx),absY=Math.abs(dy);
 if(absX<6&&absY<6)return;
 if(absX>absY){
   activeDir=dx>0?"right":"left";
   keys.ArrowRight=dx>0;keys.ArrowLeft=dx<0;
   delete keys.ArrowUp;delete keys.ArrowDown;
 }else{
   activeDir=dy>0?"down":"up";
   keys.ArrowUp=dy<0;keys.ArrowDown=dy>0;
   delete keys.ArrowLeft;delete keys.ArrowRight;
 }
});
cv.addEventListener("touchend",e=>{
 if(!activeDir){fire();return;}
 setTimeout(()=>{
   delete keys.ArrowUp;delete keys.ArrowDown;
   delete keys.ArrowLeft;delete keys.ArrowRight;
   activeDir=null;
 },180);
});

// === START ===
function startGame(){exited=false;O.style.display="none";AC.resume();startTheme();initGame(1);}
function initGame(n){
 level=n;nextLevelPending=false;paused=false;gameOver=false;
 player={x:200,y:520,dir:0,speed:2,reload:0,color:"lime",invul:0};
 enemy={x:200,y:80,dir:Math.PI,spd:1.5+level*0.2,reload:0,color:"red"};
 bullets=[];ebullets=[];explosions=[];walls=[];
 const count=Math.min(level*2,18);
 for(let i=0;i<count;i++)walls.push({x:40+Math.random()*320,y:80+Math.random()*440,w:40,h:20});
 scoreDisplay.textContent="Score: "+score;
 livesDisplay.textContent="‚ù§Ô∏è".repeat(lives);
}

// === GAMEPLAY ===
function fire(){
 if(player.reload>0)return;
 const s=Math.sin(player.dir),c=Math.cos(player.dir);
 bullets.push({x:player.x+24*c,y:player.y+24*s,vx:4*c,vy:4*s,b:2,color:"lime"});
 player.reload=25;beep("square",600,0.1,0.25);
}
function enemyFire(){
 if(enemy.reload>0)return;
 const s=Math.sin(enemy.dir),c=Math.cos(enemy.dir);
 ebullets.push({x:enemy.x+24*c,y:enemy.y+24*s,vx:4*c,vy:4*s,b:2,color:"orange"});
 enemy.reload=60;beep("square",300,0.1,0.25);
}
function makeExplosion(x,y,color){
 explosions.push({x,y,r:5,max:25,color,life:30});
 beep("sine",200,0.3,0.3);beep("triangle",900,0.15,0.2);
}
function rectHit(x,y,w,h,px,py,r){return px+r>x&&px-r<x+w&&py+r>y&&py-r<y+h;}
function tankWallCollision(t){
 for(const w of walls){
  if(t.x+15>w.x&&t.x-15<w.x+w.w&&t.y+15>w.y&&t.y-15<w.y+w.h){
    const dx=t.x-(w.x+w.w/2),dy=t.y-(w.y+w.h/2);
    if(Math.abs(dx)>Math.abs(dy))t.x+=Math.sign(dx)*2;else t.y+=Math.sign(dy)*2;
  }
 }
}

function loseLife(){
  lives--;
  makeExplosion(player.x,player.y,"red");
  if(lives<=0){
    lives=0;gameOver=true;
    beep("square",120,0.4,0.3);
  }else{
    player.x=200;player.y=520;player.invul=120; // 2s invulnerability
  }
  livesDisplay.textContent="‚ù§Ô∏è".repeat(lives);
}

function update(){
 if(gameOver||paused||exited||O.style.display!=="none")return;
 if(keys.ArrowLeft)player.dir-=0.07;
 if(keys.ArrowRight)player.dir+=0.07;
 if(keys.ArrowUp){player.x+=Math.cos(player.dir)*player.speed;player.y+=Math.sin(player.dir)*player.speed;}
 if(keys.ArrowDown){player.x-=Math.cos(player.dir)*player.speed;player.y-=Math.sin(player.dir)*player.speed;}
 player.x=Math.max(25,Math.min(arena.w-25,player.x));
 player.y=Math.max(25,Math.min(arena.h-25,player.y));
 if(player.invul>0)player.invul--;
 tankWallCollision(player);
 if(keys.Space)fire();

 const dx=player.x-enemy.x,dy=player.y-enemy.y,ang=Math.atan2(dy,dx);
 const diff=((ang-enemy.dir+Math.PI*3)%(Math.PI*2))-Math.PI;
 enemy.dir+=Math.sign(diff)*0.03;
 enemy.x+=Math.cos(enemy.dir)*enemy.spd;
 enemy.y+=Math.sin(enemy.dir)*enemy.spd;
 tankWallCollision(enemy);
 if(Math.random()<0.02*level)enemyFire();

 [bullets,ebullets].forEach(arr=>{
  for(let i=arr.length-1;i>=0;i--){
    const b=arr[i];b.x+=b.vx;b.y+=b.vy;
    for(const w of walls){
      if(rectHit(w.x,w.y,w.w,w.h,b.x,b.y,5)){
        if(Math.abs(b.x-(w.x+w.w/2))>Math.abs(b.y-(w.y+w.h/2)))b.vx*=-1;else b.vy*=-1;
        b.b--;break;
      }
    }
    if(b.x<10||b.x>390){b.vx*=-1;b.b--;}
    if(b.y<10||b.y>590){b.vy*=-1;b.b--;}
    if(b.b<0)arr.splice(i,1);
  }
 });

 bullets.forEach((b,i)=>{
   if(Math.hypot(b.x-enemy.x,b.y-enemy.y)<30){
     bullets.splice(i,1);score+=100;
     makeExplosion(enemy.x,enemy.y,"orange");nextLevelPending=true;
   }
 });
 ebullets.forEach((b,i)=>{
   if(Math.hypot(b.x-player.x,b.y-player.y)<30 && player.invul<=0){
     ebullets.splice(i,1);
     loseLife();
   }
 });

 explosions.forEach(e=>{e.r+=1.2;e.life--;});
 explosions=explosions.filter(e=>e.life>0);
 if(player.reload>0)player.reload--;if(enemy.reload>0)enemy.reload--;
 if(nextLevelPending){level++;initGame(level);}
 scoreDisplay.textContent="Score: "+score;
}

function drawTank(t){
 ctx.save();ctx.translate(t.x,t.y);ctx.rotate(t.dir);
 ctx.fillStyle=t.invul>0?((t.invul%10<5)?"#444":t.color):t.color;
 ctx.fillRect(-15,-15,30,30);
 ctx.fillStyle="#111";ctx.fillRect(0,-3,24,6);
 ctx.restore();
}
function draw(){
 ctx.clearRect(0,0,arena.w,arena.h);
 ctx.fillStyle="#666";walls.forEach(w=>ctx.fillRect(w.x,w.y,w.w,w.h));
 drawTank(player);drawTank(enemy);
 bullets.forEach(b=>{ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(b.x,b.y,7,0,Math.PI*2);ctx.fill();});
 ebullets.forEach(b=>{ctx.fillStyle=b.color;ctx.beginPath();ctx.arc(b.x,b.y,7,0,Math.PI*2);ctx.fill();});
 explosions.forEach(e=>{const g=ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r);g.addColorStop(0,e.color);g.addColorStop(1,"transparent");ctx.fillStyle=g;ctx.beginPath();ctx.arc(e.x,e.y,e.r,0,Math.PI*2);ctx.fill();});
 if(gameOver){ctx.fillStyle="red";ctx.font="40px Arial";ctx.fillText("GAME OVER",80,300);}
 if(paused){ctx.fillStyle="#fff8";ctx.font="36px Arial";ctx.fillText("PAUSED",130,300);}
}
function loop(){update();draw();requestAnimationFrame(loop);}
initGame(1);loop();
})();
</script>
</body>
</html>